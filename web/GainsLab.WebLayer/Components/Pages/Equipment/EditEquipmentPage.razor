@page "/equipments/{id:guid}"


@rendermode InteractiveServer

@using GainsLab.Application.DTOs
@using GainsLab.Application.Results
@using GainsLab.Contracts
@using GainsLab.Contracts.Dtos.Delete.Outcome
@using GainsLab.Contracts.Dtos.GetDto
@using GainsLab.Contracts.Dtos.ID
@using GainsLab.Contracts.Dtos.UpdateDto.Outcome
@using GainsLab.Domain.Interfaces
@using GainsLab.Infrastructure.Caching.Registry
@using GainsLab.WebLayer.Components.Control
@using GainsLab.WebLayer.Components.Control.Equipment
@using GainsLab.WebLayer.Model.Dto.Descriptor
@using GainsLab.WebLayer.Model.Dto.Equipment
@using GainsLab.WebLayer.Model.Notification
@using GainsLab.WebLayer.Model.Notification.Confirmation

@implements IDisposable
@inject NavigationManager NavManager;

<p>
    @if (EditEquipment != null)
    {
        <EquipmentFormComponent FormName="equipmentEditForm"
                                Model="EditEquipment"
                                OnMessages="OnMessageFromForm"
                                DisplayBackButton="@true"
                                BackButtonText="Close"
                                SubmitButtonText="Update"
                                EquipmentNames="@EquipmentNames"
                                OnSubmit="Update">
        </EquipmentFormComponent>
    }
    <br/>
    <br/> @if (Equipment != null)
           {
               <button class="btn btn-primary" @onclick="Delete">Delete</button>
           }

    <MessageComponent Messages="@Messages"></MessageComponent>

</p>

@code {
    [Parameter] public Guid Id { get; set; } = Guid.Empty;

    [Inject] private ILogger Logger { get; set; } = default!;
    [Inject] private EquipmentRegistry EquipmentRegistry { get; set; } = default!;
    [Inject] private DescriptorRegistry DescriptorRegistry { get; set; } = default!;
    [Inject] private IToast Toast { get; set; } = default!;
    [Inject] private IConfirmDialog ConfirmDialog { get; set; } = default!;

    public EquipmentGetDTO? Equipment { get; set; } = null;
    public EquipmentEditFormDTO? EditEquipment { get; set; } = null;

    private IReadOnlyList<EquipmentGetDTO> _equipments = new List<EquipmentGetDTO>();
    public IReadOnlyList<string> EquipmentNames { get; set; } = new List<string>();

    public MessagesContainer? Messages { get; set; } = new MessagesContainer();

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        Messages ??= new MessagesContainer();

        Messages.ClearAll();

        var equipments = await EquipmentRegistry.GetAllAsync();
        if (equipments.Value == null || equipments.Value.Count == 0)
        {
            Messages.AddError("No Equipments Found");
            return;
        }

        _equipments = equipments.Value!;
        EquipmentNames = _equipments.Select(e => e.Name ?? string.Empty).ToList();

        var eq = _equipments.FirstOrDefault(e => e.Id == Id);
        if (eq == null)
        {
            Messages.AddError("Equipment not found");
            return;
        }

        Equipment = eq;
        EditEquipment = Equipment!.FromGetDTO();
    }

    public void Dispose()
    {
    }

    private void OnMessageFromForm(MessagesContainer obj)
    {
        Messages = obj;
        Toast.FromMessages(Messages);
    }

    private async Task Update(EquipmentFormDTO form)
    {
        Messages ??= new MessagesContainer();
        Messages.ClearAll();

        if (form is not EquipmentEditFormDTO editForm)
        {
            Toast.Error("Form type mismatch");
            return;
        }

        if (editForm.Descriptor is not DescriptorEditDTO descriptorEditDto)
        {
            Toast.Error("Descriptor type mismatch");
            return;
        }

        var request = editForm.ToUpdateRequest();

        Result<EquipmentUpdateCombinedOutcome> outcome =
            await EquipmentRegistry.UpdateEquipmentAsync(request, descriptorEditDto.ToUpdateRequest());
        if (!outcome.Success || outcome.Value == null)
        {
            var message = "Could not update equipment: ";
            Messages.AddError(message);
            Messages.Append(outcome.GetMessages());
            Toast.FromMessages(Messages);
        }
        else
        {
            Messages.Append(outcome.Value!.GetOutcomeMessages(outcome.GetMessages()));

            if (outcome.Value.Equipment != null && outcome.Value.Equipment.Outcome == UpdateOutcome.Updated)
                Toast.Success($"Equipment updated to {outcome.Value.Equipment.UpdatedState!.Name}");

            if (outcome.Value.Descriptor != null && outcome.Value.Descriptor.Outcome == UpdateOutcome.Updated)
                Toast.Success($"Equipment Description updated to {outcome.Value.Descriptor.UpdatedState!.content}");

            EquipmentRegistry.Invalidate();
            DescriptorRegistry.Invalidate();
            
            NavManager.NavigateTo("equipments");
        }
    }

    private async Task Delete()
    {
        Messages ??= new MessagesContainer();
        Messages.ClearAll();
        if (Equipment == null || Equipment.Id == Guid.Empty)
        {
            Messages.AddWarning("Invalid Equipment Id");
            Toast.Error("Could not delete equipment : Invalid Equipment");
            return;
        }

        var ok = await ConfirmDialog.ShowAsync(
            new ConfirmRequest(
                "Delete Item",
                $"Are You sure you want to delete Equipment '{Equipment.Name}' ? It can't be undone",
                "Delete",
                "Cancel",
                true));

        if (!ok)
        {
            Toast.Error($"Delete {Equipment.Name} Cancelled");
            return;
        }

        Result<EquipmentDeleteOutcome> outcome =
            await EquipmentRegistry.DeleteEquipmentAsync(new EquipmentEntityId(Equipment.Id));
        if (!outcome.Success || outcome.Value is not { Outcome: DeleteOutcome.Deleted })
        {
            Messages.Append(outcome.Messages);
            Toast.Error($"Could not delete equipment : {Messages.ToString(MessageType.Error)}");
            return;
        }

        var message = $"Equipment {outcome.Value.Id} Deleted";

        Messages.AddInfo(message);
        Toast.Success(message);
        EquipmentRegistry.Invalidate();
        DescriptorRegistry.Invalidate();
        NavManager.NavigateTo("equipments");
    }
}
