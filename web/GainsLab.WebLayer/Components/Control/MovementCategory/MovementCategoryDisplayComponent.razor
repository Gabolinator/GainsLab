@rendermode InteractiveServer
@using System.Linq
@using System.Runtime.CompilerServices
@using GainsLab.Application.Results
@using GainsLab.Contracts
@using GainsLab.Contracts.Dtos.Delete.Outcome
@using GainsLab.Contracts.Dtos.GetDto
@using GainsLab.Contracts.Dtos.ID
@using GainsLab.Domain.Interfaces
@using GainsLab.Infrastructure.Caching.Registry
@using GainsLab.WebLayer.Model
@using GainsLab.WebLayer.Model.Notification
@using GainsLab.WebLayer.Model.Notification.Confirmation

<p>
    @if (_categories == null)
    {
        @if (_error)
        {
            <p> @_errorMessage</p>
        }
        else
        {
            <p>
                <em>Loading...</em>
            </p>
        }

       
    }
    else
    {
        <table class="tableMovementCategory">
            <thead>
            <tr>
                <th>Index</th>
                <th>Name</th>
                <th aria-label="Description">Desc</th>
                <th aria-label="Parent">Parent</th>
                <th aria-label="Bases">Bases</th>
                <th aria-label="Childs">Childs</th> 
                <th>Date Updated</th>
                <th>Edit</th>
                <th>Remove</th>
            </tr>
            </thead>
            <tbody>
            @{ i = 1; }
            @foreach (var eq in _categories)
            {

                <tr>
                    <MovementCategoryTableLine Index="i"
                                               Id="eq.Id"
                                               Name="@eq.Name"
                                               Description="@GetDescription(eq)"
                                               Parent="@GetParent(eq)"
                                               BaseCategories="@GetBaseCategories(eq)"
                                               ChildCategories="@GetChildCategories(eq)"
                                               UpdatedAtUtc="@eq.UpdatedAtUtc.ToString()"
                                               EditLink="@GetEditLink(eq)"
                                               DeleteRequested="DeleteCategoryAsync">
                    </MovementCategoryTableLine>

                </tr>
                i++;
            }
            </tbody>
        </table>
    }
</p>


@code
{
    private MovementCategoryGetDTO[]? _categories = null;
    [Inject] private ILogger Logger { get; set; } = default!;
    [Inject] private IClock Clock { get; set; } = default!;
    [Inject] private MovementCategoryRegistry Repo { get; set; } = default!;
    [Inject] private IToast Toast { get; set; } = default!;
    [Inject] private IConfirmDialog ConfirmDialog { get; set; } = default!;
  
    
    private int i =1;
    private bool _error = false;
    private string? _errorMessage = null;
    private bool _initialized;

    protected override async Task OnInitializedAsync()
    {
        if (_initialized)
        {
            Logger.LogWarning(nameof(MovementCategoryDisplayComponent), $"Already initialized - {Clock.UtcNow}");
            return ;
        }
        
        Logger.Log(nameof(MovementCategoryDisplayComponent),
            $"Init instance hash: {RuntimeHelpers.GetHashCode(this)} - {Clock.UtcNow}");
        _initialized = true;
        await  base.OnInitializedAsync();
        
        await GetCategories();


    }

  

    private async Task GetCategories()
    {
        Logger.Log(nameof(MovementCategoryDisplayComponent), "Getting all Categories");
        
        _categories = null;
        _error = false;
        _errorMessage = null;

        var result = await Repo.GetAllAsync();
        ApplyResult(result);
    }

    private void ApplyResult(Result<IReadOnlyList<MovementCategoryGetDTO>> result)
    {
        if (!result.Success)
        {
            _categories = null;
            _error = true;
            _errorMessage = result.GetErrorMessage();
            return;
        }

        _error = false;
        _errorMessage = null;
        _categories = result.HasValue ? result.Value.ToArray() : null;
    }

    private string GetDescription(MovementCategoryGetDTO eq)
    {
        return eq.Descriptor?.content ?? "Description not found";
    }

    private Link? GetEditLink(MovementCategoryGetDTO eq) => new Link { Text = $" Edit: {eq.Name}", Page = $@"movement-categories/{eq.Id}" };

    private async Task DeleteCategoryAsync(Guid MovementCategoryId)
    {

        Logger.Log(nameof(MovementCategoryDisplayComponent), $"Deleting MovementCategory {MovementCategoryId}");
        
        if (_categories is null)
        {
            Toast.Error("No MovementCategory Found");
            return;
        }
        var eq = _categories.FirstOrDefault(e => e.Id == MovementCategoryId);
        if (eq == null)
        {
            Toast.Error($"No MovementCategory Found with id {MovementCategoryId}");
            return;
        }
        
        var ok = await ConfirmDialog.ShowAsync(
            new ConfirmRequest(
                "Delete Item", 
                $"Are You sure you want to delete MovementCategory '{eq.Name}' ? It can't be undone",
                "Delete", 
                "Cancel",
                true));
        
       Logger.Log(nameof(MovementCategoryDisplayComponent), $"Confirmation {ok}");
        
        if (!ok)
        {
            Toast.Error($"Delete {eq.Name} Cancelled");
            return;
        }

        
        Result<MovementCategoryDeleteOutcome> result = await Repo.DeleteCategoryAsync(new MovementCategoryEntityId(MovementCategoryId));
        if (!result.Success || result.Value is not { Outcome: DeleteOutcome.Deleted })
        {
            _error = true;
            _errorMessage = $"Unable to delete MovementCategory {MovementCategoryId}: {result.GetErrorMessage()}";
            Logger.LogError(nameof(MovementCategoryDisplayComponent), _errorMessage);
            Toast.Error(_errorMessage);
            return;
        }

        _error = false;
        _errorMessage = null;

 
        var success = $"Deleted MovementCategory {MovementCategoryId}";
        Logger.Log(nameof(MovementCategoryDisplayComponent), success);
        Toast.Success(success);
        
        _categories = _categories.Where(e => e.Id != MovementCategoryId).ToArray();
       
    }

    private string GetParent(MovementCategoryGetDTO c)
    {
        if (c.ParentCategory == null) return "None";
        return c.ParentCategory.Name;
    }

    private List<string> GetBaseCategories(MovementCategoryGetDTO c)
    {
        if (c.BaseCategories == null || !c.BaseCategories.Any()) return new();
        return c.BaseCategories.Select(c => c.Name).ToList();
    }

    private List<string> GetChildCategories(MovementCategoryGetDTO c)
    {
        if (c.ChildCategories == null || !c.ChildCategories.Any()) return new();
        return c.ChildCategories.Select(c => c.Name).ToList();
    }

   
}