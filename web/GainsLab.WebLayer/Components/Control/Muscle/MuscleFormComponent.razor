
@rendermode InteractiveServer
@using GainsLab.Application.Results
@using GainsLab.Contracts.Dtos.GetDto
@using GainsLab.Domain
@using GainsLab.Domain.Interfaces
@using GainsLab.Infrastructure.Utilities
@using GainsLab.WebLayer.Model
@using GainsLab.WebLayer.Model.Dropdown
@using GainsLab.WebLayer.Model.Dto.Descriptor
@using GainsLab.WebLayer.Model.Dto.Muscle
@using ILogger = Domain.Interfaces.ILogger

@implements IDisposable

<h3>MuscleForm</h3>

  
<EditForm EditContext="FormContext" FormName=@FormName OnValidSubmit="HandleSubmit">
    <DataAnnotationsValidator></DataAnnotationsValidator>
    <ValidationSummary></ValidationSummary>
        
            
    <div class="mb-2">
        <label>Name</label>
        <InputText Value="@Model.Name"
                   ValueChanged="OnNameChanged"
                   ValueExpression="@(() => Model.Name)"
                   @oninput="OnNameInput" />
        <ValidationMessage For="(() => Model.Name)"/>
    </div>
            
    <div class="mb-2">
        <label>Description</label>
        <InputText class="form-control"
                   @bind-Value="EditDescriptor.DescriptionContent"/>
    </div>
            
    <div class="mb-2">
        <label>BodySection</label>
        <DropdownComponent Config="BodySectionDropdown"
                           @bind-Value="SelectedBodySection"/>
    </div>
            
            
    <div class="mb-2">
        <label>Antagonists </label>
        <p>  @GetAntagonistText()   </p>
    </div>
    @if(OtherOptionsAvailable())
    { <button type="button" class="btn btn-primary" @onclick="AddAntagonist">
            @AddAntagonistText
        </button>}
   
    
    <div class="mb-2">
        @foreach (var row in _antagonistRows)
        {
            var config = BuildConfigFor(row.Id);
            <div @key="row.Id">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <DropdownComponent Config="config"
                                       Value="@row.Selected"
                                       ValueChanged="(v) => OnSelectedChanged(row.Id, v)" />

                    <button type="button" class="btn btn-outline-danger"
                            @onclick="() => RemoveAntagonist(row.Id)">
                        Remove
                    </button>
                    
                </div>
            </div>
        }
    </div>
    
    
    
    @if (IsValid())
    {
        <button class="btn btn-primary" type="submit">@SubmitButtonText</button>
    }
    
   @if (DisplayBackButton)
    {
        <a href=@BackAddress class="btn btn-primary">@BackButtonText</a>
    }
    

</EditForm>

@code
{
    
    private Guid? _lastModelId;
    [Inject] private ILogger Logger { get; set; } = default!;
    [Inject] private IClock Clock { get; set; } = default!;
    
    [Parameter] public string FormName { get; set; } = "MuscleForm";
    [Parameter] public MuscleFormDTO Model { get; set; } = new();
    [Parameter] public string SubmitButtonText { get; set; } = "Save";
    [Parameter] public EventCallback<MuscleFormDTO> OnSubmit { get; set; }= default;
    [Parameter] public bool DisplayBackButton { get; set; } = false; 
    [Parameter] public string BackButtonText { get; set; } = "Close";
    [Parameter] public string BackAddress { get; set; } = "/muscles";
    [Parameter] public IReadOnlyList<MuscleRefDTO>? Muscles { get; set; } = default;
    
    public DropdownConfig BodySectionDropdown { get; set; } = default!;


    [Parameter] public EventCallback<MessagesContainer> OnMessages { get; set; } = default;
    
    
    private List<AntagonistRow> _antagonistRows = new();
    private int _nextId = 1;
    
   //all muscles - expect this muscle
   private IReadOnlyList<string> _allOptions;

    private void AddAntagonist()
    {
        _antagonistRows.Add(new AntagonistRow { Id = _nextId++ });
    }
    
    private void RemoveAntagonist(int id)
    {
        Logger.Log(nameof(MuscleFormComponent), $"Trying to remove row with id {id} = rows {string.Join(",", _antagonistRows.Select(r=>r.Id) )}");
        
        var numRemoved = _antagonistRows.RemoveAll(r => r.Id == id);
         Logger.Log(nameof(MuscleFormComponent), $"Remove {numRemoved} row with id {id}");

         
         
        RebuildAntagonistsRefsList();
    }

    private void RebuildAntagonistsRefsList()
    {
        if (!_antagonistRows.Any() || Muscles == null || !Muscles.Any()) SelectedAntagonistsRef = new();

        SelectedAntagonistsRef = _antagonistRows
            .Select(
                r => Muscles!
                    .FirstOrDefault(
                        m => string.Equals(m.Name, r.Selected, StringComparison.InvariantCultureIgnoreCase)))
            .Where(m => m != null)
            .Select(m=>m!)
            .ToHashSet();
    }

    private void OnSelectedChanged(int id, string? value)
    {
        var row = _antagonistRows.First(r => r.Id == id);
        row.Selected = value;
        RebuildAntagonistsRefsList();
    }

    private DropdownConfig BuildConfigFor(int rowId)
    {
        List<DropdownItem> items = GetAvailableItems(rowId);
        
        return new DropdownConfig
        {
            Items = items,
            Placeholder = "Select antagonist…",
            CssClass = "form-select"
        };
    }

    private List<DropdownItem> GetAvailableItems(int rowId)
    {
        // what other rows picked (exclude current row)
        var taken = _antagonistRows
            .Where(r => r.Id != rowId)
            .Select(r => r.Selected)
            .Where(v => !string.IsNullOrWhiteSpace(v))
            .ToHashSet(StringComparer.OrdinalIgnoreCase);

        // allow current row’s own selection to stay visible
        var current = _antagonistRows.First(r => r.Id == rowId).Selected;

       return _allOptions
            .Where(opt => !taken.Contains(opt) || string.Equals(opt, current, StringComparison.OrdinalIgnoreCase))
            .OrderBy(opt => opt)
            .Select(i=>new DropdownItem{Label = i, Value = i})
            .ToList();

        
    }

    private sealed class AntagonistRow
    {
        public int Id { get; set; }
        public string? Selected { get; set; }
    }
    
    public MessagesContainer? Messages { get; set; } = new MessagesContainer();
    public DescriptorFormDTO EditDescriptor { get; set; }
    
    public string SelectedBodySection { get => SelectedBodySectionEnum.ToString();  set => OnBodySectionChanged(value); }
    private string _selectedBodySection;
   
    private eBodySection SelectedBodySectionEnum { get; set; } = eBodySection.undefined;
    private HashSet<string> ExistingMuscleNames { get; set; } = new HashSet<string>();

    
    private HashSet<MuscleRefDTO>? SelectedAntagonistsRef { get; set; } = null;
    private string AddAntagonistText { get; set; } = "Add Antagonist";
    public DropdownConfig? AntagonistDropdown { get; set; }
   


    private EditContext? FormContext;
    private ValidationMessageStore? _validationMessages;
    private FieldIdentifier _nameField;
    private bool _isEditValid;
    private string? _normalizedOriginalName;
    private string _originalDescriptorContent;
    private bool _seededAntagonists;
    private eBodySection _originalBodySection = eBodySection.undefined;
    private List<MuscleRefDTO>? _originalAntagonists;


    private Task OnNameChanged(string value)
    {
        // This is what EditContext uses for standard change notifications
        Model!.Name = value;
        return Task.CompletedTask;
    }

    private void OnNameInput(ChangeEventArgs e)
    {
       Model!.Name = e.Value?.ToString();

        FormContext?.NotifyFieldChanged(_nameField);
    }

 
    
    private void OnBodySectionChanged(string value)
    {
        _selectedBodySection = value;
        Logger.Log(nameof(MuscleFormComponent), $"Setting body section: {value}");
       
        if (string.IsNullOrEmpty(value) || !Enum.TryParse(value, out eBodySection selectedBodySection))
        {
            Logger.LogWarning(nameof(MuscleFormComponent), $"Invalid body section: {value}");
            SelectedBodySectionEnum = eBodySection.undefined;
        }

        else
        {
            Logger.Log(nameof(MuscleFormComponent), $"Body Section changed to : {selectedBodySection}");
            SelectedBodySectionEnum = selectedBodySection;
        }

        if (!IsBodySectionValid())
        {
            Messages ??= new MessagesContainer();
            Messages.ClearAll();
            var message = "BodySection Can't be undefined";
            Messages.AddWarning(message);
            OnMessages.InvokeAsync(Messages);
        }
    }
    
    private bool IsBodySectionValid() => SelectedBodySectionEnum != eBodySection.undefined;

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        
        if (_lastModelId != Model.Id)
        {
            _lastModelId = Model.Id;
            _seededAntagonists = false;
            SelectedBodySectionEnum = Model.BodySection;
            SelectedAntagonistsRef = Model.Antagonists == null ? new HashSet<MuscleRefDTO>() : Model.Antagonists.ToHashSet();
            EditDescriptor = Model.Descriptor;
            _normalizedOriginalName = Normalize(Model!.Name);
            _originalDescriptorContent = Normalize(EditDescriptor.DescriptionContent);
            _originalBodySection = Model.BodySection;
            _originalAntagonists = Model.Antagonists;
        }

        if (!_seededAntagonists)
        {
            Logger.Log(nameof(MuscleFormComponent), "Seeding Antagonist");
            _antagonistRows.Clear();
            _nextId = 1;
            AddAntagonists(SelectedAntagonistsRef);
            
            _seededAntagonists = true;
        }
        
        //create drowdown options 
        List<DropdownItem> bodySectionOptions = GetBodySections();
        
        BodySectionDropdown = new DropdownConfig { Items = bodySectionOptions}; //Placeholder =  "Select BodySection..." , InitialSelectedLabel = m.BodySection.ToString()
        
       
        _allOptions = Muscles != null ?Muscles.Where(m => m.Id != Model.Id).Select(m=>m.Name).ToList() : new List<string>();
        
        
        BuildEditContext();

        
    }

    private void AddAntagonists(HashSet<MuscleRefDTO>? selectedAntagonistsRef)
    {
      if(selectedAntagonistsRef == null || selectedAntagonistsRef.Count == 0) return;
      
      foreach (var muscleRef in selectedAntagonistsRef)
      {
          
          if (string.IsNullOrEmpty(muscleRef.Name)) continue;
          
          _antagonistRows.Add(new AntagonistRow{Id = _nextId, Selected = muscleRef.Name});
          _nextId++;

      }
      
    }

    private List<DropdownItem> GetBodySections()
    {
        var bodySection = Enum.GetValues<eBodySection>();
        var bodySectionString = bodySection.Select(b=>b.ToString()).OrderBy(c=>c).ToList();
        return bodySectionString.Select(s=>new DropdownItem{Label = s, Value = s}).ToList();
    }
    
    private string GetAntagonistText()
    {
        if (SelectedAntagonistsRef == null || SelectedAntagonistsRef.Count == 0) return "None";

        return string.Join(',', SelectedAntagonistsRef.OrderBy(c => c.Name.ToString()).Select(c => c.Name.ToString()));

    }
    
     private void BuildEditContext()
    {
        if (FormContext != null)
        {
            FormContext.OnFieldChanged -= HandleFieldChanged;
            FormContext.OnValidationRequested -= HandleValidationRequested;
        }

        FormContext = new EditContext(Model!);
        _validationMessages = new ValidationMessageStore(FormContext);

        _nameField = FieldIdentifier.Create(() => Model!.Name);

        FormContext.OnFieldChanged += HandleFieldChanged;
        FormContext.OnValidationRequested += HandleValidationRequested;

        ValidateUniqueName();
    }

    private void HandleFieldChanged(object? sender, FieldChangedEventArgs e)
    {
        if (e.FieldIdentifier.FieldName == nameof(MuscleGetDTO.Name))
        {
            ValidateUniqueName();
        }


    }

    private void HandleValidationRequested(object? sender, ValidationRequestedEventArgs e)
    {
        ValidateUniqueName();
    }

    private void ValidateUniqueName()
    {
        if (FormContext == null || _validationMessages == null)
            return;


        _validationMessages.Clear(_nameField);

        Messages ??= new MessagesContainer();

        Messages.Clear(MessageType.Warning);

        var candidate = Normalize(Model.Name);

        if (string.IsNullOrWhiteSpace(candidate))
        {
            _isEditValid = false;
          //  EditMuscle.UpdateRequest = UpdateRequest.DontUpdate;
            FormContext.NotifyValidationStateChanged();
            return;
        }

        if (ExistingMuscleNames.Contains(candidate))
        {
            _validationMessages.Add(_nameField, "An Muscle with this name already exists.");
            _isEditValid = false;
          //  EditMuscle.UpdateRequest = UpdateRequest.DontUpdate;
            FormContext.NotifyValidationStateChanged();
            return;
        }

        if (string.Equals(candidate, _normalizedOriginalName, StringComparison.InvariantCultureIgnoreCase))
        {
            var warning = $"Validated Muscle Name - unchanged candidate {candidate}";
            Messages.AddWarning(warning);
            Logger.Log(nameof(MuscleFormComponent), warning);
            _validationMessages.Clear(_nameField);
            _isEditValid = true;
         //   EditMuscle.UpdateRequest = UpdateRequest.DontUpdate;
            FormContext.NotifyValidationStateChanged();
            return;
        }

        _isEditValid = true;
      //  EditMuscle.UpdateRequest = UpdateRequest.Update;
        FormContext.NotifyValidationStateChanged();
    }

    
    private static string Normalize(string? name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return string.Empty;

        var t = StringFormater.RemoveUnwantedChar(name);

        return t;
    }

    public void Dispose()
    {
        if (FormContext != null)
        {
            FormContext.OnFieldChanged -= HandleFieldChanged;
            FormContext.OnValidationRequested -= HandleValidationRequested;
        }
    }
    
    private async Task HandleSubmit()
    {
        Logger.Log(nameof(HandleSubmit), "Submiting.");
        Messages ??= new MessagesContainer();
        Messages.ClearAll();
        
        if (!ValidateModel(out MessagesContainer messages))
        {
            Logger.LogWarning(nameof(HandleSubmit), "Model not valid.");
            Messages.Append(messages);
            await OnMessages.InvokeAsync(Messages);
            return;
        }

        Messages.Append(messages);
        ConstructModel();
        
        await OnMessages.InvokeAsync(Messages);
        await OnSubmit.InvokeAsync(Model);
    }

      private bool ValidateModel(out MessagesContainer messages)
    {
        messages = new MessagesContainer();
        var currentDescriptorContent = Normalize(EditDescriptor.DescriptionContent);
        
        bool descriptionChanged = false;
        
        if (string.Equals(currentDescriptorContent, _originalDescriptorContent, StringComparison.InvariantCultureIgnoreCase))
        {
            messages.AddWarning($"Muscle {Model!.Name} description content did not change");
            EditDescriptor.ApplyRequest = Request.DontApplyRequest;
        }
        else
        {
            EditDescriptor.ApplyRequest = Request.ApplyRequest;
            descriptionChanged = true;
        }
        
        //todo check if changed
        bool anythingChangedInCategory = false;

        if (!_normalizedOriginalName.Equals(Normalize(Model.Name), StringComparison.InvariantCultureIgnoreCase))
        {
            anythingChangedInCategory = true;
            messages.AddInfo($"Changed Name to {Model.Name}");
        }
        else
        {
            messages.AddWarning($"Name Did not change");
        }

        if (_originalBodySection != SelectedBodySectionEnum)
        {
            anythingChangedInCategory = true;
            messages.AddInfo($"Changed Body Section to {SelectedBodySectionEnum}");
        }
        else
        {
            messages.AddWarning($"BodySection Did not change");
        }
        
        
        if (AsAntagonistChanged(_originalAntagonists, SelectedAntagonistsRef))
        {
            anythingChangedInCategory = true;
            messages.AddInfo($"Changed Antagonists to {SelectedAntagonistsRef}");
        }
        else
        {
            messages.AddWarning($"Antagonists Did not change");
        }

        
        
        Model.ApplyRequest = anythingChangedInCategory ? Request.ApplyRequest : Request.DontApplyRequest;
        var nothingChanged = !anythingChangedInCategory && !descriptionChanged;
        if(nothingChanged) messages.AddError("Wont Update : Nothing Changed in Category");
        return  anythingChangedInCategory || descriptionChanged ;
    }

    private bool AsAntagonistChanged(List<MuscleRefDTO>? originalAntagonists, HashSet<MuscleRefDTO>? selectedAntagonistsRef)
    {
        if ((originalAntagonists == null || originalAntagonists.Count == 0) &&
            (selectedAntagonistsRef == null || selectedAntagonistsRef.Count == 0))
        {
            return false;
        }

        if (originalAntagonists == null || selectedAntagonistsRef == null)
        {
            return true;
        }

        if (originalAntagonists.Count != selectedAntagonistsRef.Count)
        {
            return true;
        }

        var selectedIds = selectedAntagonistsRef.Select(a => a.Id).ToHashSet();
        foreach (var antagonist in originalAntagonists)
        {
            if (!selectedIds.Contains(antagonist.Id))
            {
                return true;
            }
        }

        return false;
    }

    private void ConstructModel()
    {
        Model.Descriptor = EditDescriptor;
        Logger.Log(nameof(MuscleFormComponent), $"Descriptor : {Model.Descriptor.DescriptionContent}");
        Model.BodySection = SelectedBodySectionEnum;
        Model.Antagonists = SelectedAntagonistsRef?.ToList();
    }

    
    private bool IsValid()
    {
        //todo
        return true;
    }

  

    private bool OtherOptionsAvailable()
    {
        if (!_allOptions.Any()) return false;
        if (!_antagonistRows.Any()) return true;

        return _allOptions.Count != _antagonistRows.Count;
    }
}
