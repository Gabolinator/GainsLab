@rendermode InteractiveServer

@using GainsLab.Application.Results
@using GainsLab.Domain
@using GainsLab.Domain.Interfaces
@using GainsLab.Infrastructure.Utilities
@using GainsLab.WebLayer.Model
@using GainsLab.WebLayer.Model.Dto.Descriptor
@using GainsLab.WebLayer.Model.Dto.Equipment
@using GainsLab.WebLayer.Model.Notification
@using ILogger = Domain.Interfaces.ILogger

@implements IDisposable

<h3>EquipmentFormComponent</h3>

<EditForm EditContext="FormContext" FormName="@FormName" OnValidSubmit="HandleSubmit">
    <DataAnnotationsValidator></DataAnnotationsValidator>
    <ValidationSummary></ValidationSummary>

    <div class="mb-2">
        <label>Name</label>
        <InputText Value="@Model.Name"
                   ValueChanged="OnNameChanged"
                   ValueExpression="@(() => Model.Name)"
                   @oninput="OnNameInput" />
        <ValidationMessage For="(() => Model.Name)"/>
    </div>

    <div class="mb-2">
        <label>Description</label>
        <InputText class="form-control"
                   @bind-Value="EditDescriptor.DescriptionContent"/>
    </div>

    @if (IsValid())
    {
        <button class="btn btn-primary" type="submit">@SubmitButtonText</button>
    }

    @if (DisplayBackButton)
    {
        <a href="@BackAddress" class="btn btn-primary">@BackButtonText</a>
    }

</EditForm>

@code
{
    [Inject] private ILogger Logger { get; set; } = default!;

    [Parameter] public string FormName { get; set; } = "EquipmentForm";
    [Parameter] public EquipmentFormDTO Model { get; set; } = new();
    [Parameter] public string SubmitButtonText { get; set; } = "Save";
    [Parameter] public bool DisplayBackButton { get; set; } = false;
    [Parameter] public string BackButtonText { get; set; } = "Close";
    [Parameter] public string BackAddress { get; set; } = "/equipments";
    [Parameter] public EventCallback<EquipmentFormDTO> OnSubmit { get; set; } = default;
    [Parameter] public EventCallback<MessagesContainer> OnMessages { get; set; } = default;
    [Parameter] public IReadOnlyList<string>? EquipmentNames { get; set; } = default;

    public MessagesContainer? Messages { get; set; } = new MessagesContainer();

    public DescriptorFormDTO EditDescriptor { get; set; } = new();

    private EditContext? FormContext;
    private ValidationMessageStore? _validationMessages;
    private FieldIdentifier _nameField;
    private bool _isEditValid;
    private string _normalizedOriginalName = string.Empty;
    private string _originalDescriptorContent = string.Empty;
    private HashSet<string> _existingEquipmentNames = new(StringComparer.InvariantCultureIgnoreCase);

    private Task OnNameChanged(string value)
    {
        Model!.Name = value;
        return Task.CompletedTask;
    }

    private void OnNameInput(ChangeEventArgs e)
    {
        Model!.Name = e.Value?.ToString();
        FormContext?.NotifyFieldChanged(_nameField);
    }

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        Messages ??= new MessagesContainer();

        EditDescriptor = Model.Descriptor ?? (Model switch
        {
            EquipmentCreateDTO => new DescriptorCreateDTO(),
            _ => new DescriptorEditDTO()
        });
        Model.Descriptor = EditDescriptor;

        _normalizedOriginalName = Normalize(Model.Name);
        _originalDescriptorContent = Normalize(EditDescriptor.DescriptionContent);

        _existingEquipmentNames = EquipmentNames?
            .Select(Normalize)
            .Where(n => !string.IsNullOrWhiteSpace(n))
            .ToHashSet(StringComparer.InvariantCultureIgnoreCase) ??
            new HashSet<string>(StringComparer.InvariantCultureIgnoreCase);

        BuildEditContext();
    }

    private void BuildEditContext()
    {
        if (FormContext != null)
        {
            FormContext.OnFieldChanged -= HandleFieldChanged;
            FormContext.OnValidationRequested -= HandleValidationRequested;
        }

        FormContext = new EditContext(Model!);
        _validationMessages = new ValidationMessageStore(FormContext);
        _nameField = FieldIdentifier.Create(() => Model!.Name);

        FormContext.OnFieldChanged += HandleFieldChanged;
        FormContext.OnValidationRequested += HandleValidationRequested;

        ValidateUniqueName();
    }

    private void HandleFieldChanged(object? sender, FieldChangedEventArgs e)
    {
        if (e.FieldIdentifier.FieldName == nameof(EquipmentFormDTO.Name))
        {
            ValidateUniqueName();
        }
    }

    private void HandleValidationRequested(object? sender, ValidationRequestedEventArgs e)
    {
        ValidateUniqueName();
    }

    private void ValidateUniqueName()
    {
        if (FormContext == null || _validationMessages == null)
            return;

        _validationMessages.Clear(_nameField);

        Messages ??= new MessagesContainer();
        Messages.Clear(MessageType.Warning);

        var candidate = Normalize(Model.Name);

        if (string.IsNullOrWhiteSpace(candidate))
        {
            _isEditValid = false;
            FormContext.NotifyValidationStateChanged();
            return;
        }

        if (_existingEquipmentNames.Contains(candidate) &&
            !string.Equals(candidate, _normalizedOriginalName, StringComparison.InvariantCultureIgnoreCase))
        {
            _validationMessages.Add(_nameField, "An equipment with this name already exists.");
            _isEditValid = false;
            FormContext.NotifyValidationStateChanged();
            return;
        }

        if (string.Equals(candidate, _normalizedOriginalName, StringComparison.InvariantCultureIgnoreCase) &&
            Model is EquipmentEditFormDTO)
        {
            Messages.AddWarning($"Name did not change");
        }

        _isEditValid = true;
        FormContext.NotifyValidationStateChanged();
    }

    private async Task HandleSubmit()
    {
        Messages ??= new MessagesContainer();
        Messages.ClearAll();

        if (!ValidateModel(out var validationMessages))
        {
            Messages.Append(validationMessages);
            await OnMessages.InvokeAsync(Messages);
            return;
        }

        Messages.Append(validationMessages);
        await OnMessages.InvokeAsync(Messages);
        await OnSubmit.InvokeAsync(Model);
    }

    private bool ValidateModel(out MessagesContainer messages)
    {
        messages = new MessagesContainer();

        if (Model is EquipmentCreateDTO createDto)
        {
            var validation = createDto.IsValid(Logger);
            if (!validation.Success)
            {
                messages.AddError("Equipment name invalid");
                messages.Append(validation.Messages);
                return false;
            }
        }

        if (!ValidateDescriptor(messages, out var descriptorChanged))
        {
            return false;
        }

        var nameChanged = EvaluateNameChanges(messages);

        if (Model is EquipmentEditFormDTO && !nameChanged && !descriptorChanged)
        {
            messages.AddError("Wont Update : Nothing changed in Equipment");
            return false;
        }

        return true;
    }

    private bool ValidateDescriptor(MessagesContainer messages, out bool descriptorChanged)
    {
        descriptorChanged = false;

        switch (EditDescriptor)
        {
            case DescriptorCreateDTO createDescriptor:
                var descriptorValid = createDescriptor.IsValid(Logger);
                if (!descriptorValid.Success)
                {
                    messages.AddError("Equipment description content invalid");
                    messages.Append(descriptorValid.Messages);
                    return false;
                }

                createDescriptor.ApplyRequest = Request.ApplyRequest;
                descriptorChanged = true;
                break;
            case DescriptorEditDTO descriptorEdit:
                var currentDescriptorContent = Normalize(descriptorEdit.DescriptionContent);
                if (string.Equals(currentDescriptorContent, _originalDescriptorContent, StringComparison.InvariantCultureIgnoreCase))
                {
                    descriptorEdit.ApplyRequest = Request.DontApplyRequest;
                    messages.AddWarning("Description did not change");
                    descriptorChanged = false;
                }
                else
                {
                    descriptorEdit.ApplyRequest = Request.ApplyRequest;
                    messages.AddInfo("Changed Description");
                    descriptorChanged = true;
                }

                break;
            default:
                break;
        }

        return true;
    }

    private bool EvaluateNameChanges(MessagesContainer messages)
    {
        var candidate = Normalize(Model.Name);

        if (Model is EquipmentEditFormDTO)
        {
            if (!string.Equals(candidate, _normalizedOriginalName, StringComparison.InvariantCultureIgnoreCase))
            {
                Model.ApplyRequest = Request.ApplyRequest;
                messages.AddInfo($"Changed Name to {Model.Name}");
                return true;
            }

            Model.ApplyRequest = Request.DontApplyRequest;
            messages.AddWarning("Name did not change");
            return false;
        }

        Model.ApplyRequest = Request.ApplyRequest;
        return true;
    }

    private bool IsValid() => _isEditValid;

    private static string Normalize(string? name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return string.Empty;

        return StringFormater.RemoveUnwantedChar(name);
    }

    public void Dispose()
    {
        if (FormContext != null)
        {
            FormContext.OnFieldChanged -= HandleFieldChanged;
            FormContext.OnValidationRequested -= HandleValidationRequested;
        }
    }
}
