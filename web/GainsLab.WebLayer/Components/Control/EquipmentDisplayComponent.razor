
@rendermode InteractiveServer
@using System.Linq
@using GainsLab.Application.Interfaces.DataManagement.Gateway
@using GainsLab.Application.Results
@using GainsLab.Contracts
@using GainsLab.Contracts.Dtos.Delete.Outcome
@using GainsLab.Contracts.Dtos.GetDto
@using GainsLab.Contracts.Dtos.ID
@using GainsLab.Domain.Interfaces
@using GainsLab.WebLayer.Model


@attribute [StreamRendering]


<p>
    @if (_equipments == null)
    {
        @if (_error)
        {
            <p> @_errorMessage</p>
        }
        else
        {
            <p>
                <em>Loading...</em>
            </p>
        }

       
    }
    else
    {
        <table class="tableEquipment">
            <thead>
            <tr>
                <th>Index</th>
                <th>Name</th>
                <th aria-label="Description">Desc</th>
                <th>Date Updated</th>
                <th>Edit</th>
                <th>Remove</th>
            </tr>
            </thead>
            <tbody>
            @foreach (var eq in _equipments)
            {

                <tr>
                    <EquipmentTableLine Index="i"
                                        Name="@eq.Name"
                                        Description="@GetDescription(eq)"
                                        UpdatedAtUtc="@eq.UpdatedAtUtc.ToString()"
                                        EditLink="@GetEditLink(eq)"
                                        EquipmentId="@eq.Id"
                                        DeleteRequested="DeleteEquipmentAsync">
                    </EquipmentTableLine>

                </tr>
                i++;
            }
            </tbody>
        </table>
    }
</p>


@code
{
    private EquipmentGetDTO[]? _equipments = null;
    [Inject] private ILogger Logger { get; set; } = default!;
    [Inject] private IClock Clock { get; set; } = default!;
    [Inject] private IEquipmentGateway Repo { get; set; } = default!;
    
    
    private int i =1;
    private bool _error = false;
    private string? _errorMessage = null;

    protected override Task OnInitializedAsync()
    {
        Logger.Log("HomePage", $"Getting all equipments");
        
        base.OnInitializedAsync();

        return GetEquipments();


    }

    private async Task GetEquipments()
    {
        _equipments = null;

        Result<IReadOnlyList<EquipmentGetDTO>> result = await Repo.GetAllEquipmentsAsync();
        if (!result.Success)
        {
            _equipments = null;
            _error = true;
            _errorMessage = result.GetErrorMessage();
            return;
        }

        _equipments = !result.HasValue ? null : result.Value.ToArray();
    }

    private string GetDescription(EquipmentGetDTO eq)
    {
        return eq.Descriptor?.content ?? "Description not found";
    }

    private Link? GetEditLink(EquipmentGetDTO eq) => new Link { Text = $" Edit: {eq.Name}", Page = $@"equipments/{eq.Id}" };

    private async Task DeleteEquipmentAsync(Guid equipmentId)
    {
        Logger.Log(nameof(EquipmentDisplayComponent), $"Deleting equipment {equipmentId}");
        Result<EquipmentDeleteOutcome> result = await Repo.DeleteEquipmentAsync(new EquipmentEntityId(equipmentId));
        if (!result.Success || result.Value is not { Outcome: DeleteOutcome.Deleted })
        {
            _error = true;
            _errorMessage = $"Unable to delete equipment {equipmentId}: {result.GetErrorMessage()}";
            Logger.LogError(nameof(EquipmentDisplayComponent), _errorMessage);

            return;
        }

        _error = false;
        _errorMessage = null;

        if (_equipments is null)
        {
            return;
        }

        Logger.Log(nameof(EquipmentDisplayComponent), $"Deleted equipment {equipmentId}");

        
        _equipments = _equipments.Where(eq => eq.Id != equipmentId).ToArray();
    }
}
